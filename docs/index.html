<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ðŸ“Š Trading Dashboard</title>
  <link rel="stylesheet" href="style.css" />
  <style>
    /* Minimal falls style.css fehlt */
    body{background:#0b1620;color:#e6edf3;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px}
    h1{display:flex;gap:10px;align-items:center;margin:0 0 16px}
    .card{background:#0f1f2e;border:1px solid #203040;border-radius:12px;padding:12px 12px 4px;margin:12px 0;box-shadow:0 2px 10px rgba(0,0,0,.25)}
    table{width:100%;border-collapse:separate;border-spacing:0;overflow:hidden}
    th,td{padding:10px 12px;border-bottom:1px solid #1d2a38;white-space:nowrap}
    th{color:#a6b6c6;font-weight:600;text-align:left;background:#102233;position:sticky;top:0;z-index:1}
    tr:hover{background:#0f2538}
    .toolbar{display:flex;gap:10px;align-items:center;margin:8px 0 16px}
    .btn{background:#1b4b77;border:1px solid #2a6ca3;border-radius:10px;color:#fff;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn:active{transform:translateY(1px)}
    .muted{color:#8aa0b6;font-size:.9rem}
    .badge{padding:4px 8px;border-radius:999px;font-weight:700;font-size:.75rem}
    .buy{background:#0e6b2f}
    .hold{background:#5b6471}
    .err{background:#7b1b2a}
    .ki{background:#4b2fa3}
    .right{text-align:right}
    .center{text-align:center}
    .spark{width:130px;height:28px}
    .pill{border:1px solid #2b3f54;color:#aac2da;background:#0f2132;border-radius:999px;padding:2px 8px;font-size:.75rem}
    .filters{display:flex;gap:10px;flex-wrap:wrap}
    .row-error td{color:#ffb4c2}
  </style>
</head>
<body>
  <h1>ðŸ“Š <span>Trading Dashboard</span></h1>

  <div class="toolbar">
    <div class="filters">
      <label class="pill"><input id="only-buys" type="checkbox" style="vertical-align:middle;margin-right:6px" />Nur BUY zeigen</label>
      <label class="pill"><input id="sort-desc" type="checkbox" checked style="vertical-align:middle;margin-right:6px" />Î”% absteigend</label>
    </div>
    <button id="btn-refresh" class="btn">Jetzt aktualisieren</button>
    <span id="last-info" class="muted"></span>
  </div>

  <div class="card">
    <div class="muted" style="padding:4px 8px 10px">Aktuelle Signale</div>
    <div style="overflow:auto">
      <table>
        <thead>
        <tr>
          <th>Symbol</th>
          <th class="right">Preis</th>
          <th class="right">% Î”</th>
          <th class="right">RSI</th>
          <th class="center">Breakout</th>
          <th class="center">Momentum</th>
          <th class="center">Empfehlung</th>
          <th class="right">SL</th>
          <th class="right">TP</th>
          <th class="right">Trail</th>
          <th class="center">KI</th>
          <th class="center">Chart</th>
        </tr>
        </thead>
        <tbody id="signals-body"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="muted" style="padding:4px 8px 10px">Exits</div>
    <div style="overflow:auto">
      <table>
        <thead>
        <tr>
          <th>Datum</th>
          <th>Symbol</th>
          <th class="right">Preis</th>
          <th>Grund</th>
        </tr>
        </thead>
        <tbody id="exits-body"></tbody>
      </table>
    </div>
  </div>

<script>
const $signalsBody = document.querySelector('#signals-body');
const $exitsBody   = document.querySelector('#exits-body');
const $lastInfo    = document.querySelector('#last-info');
const $onlyBuys    = document.querySelector('#only-buys');
const $sortDesc    = document.querySelector('#sort-desc');

function fmtNum(n, d=2){ return (n===null||n===undefined||isNaN(n)) ? 'â€“' : Number(n).toFixed(d); }
function cell(txt, cls=''){ const td=document.createElement('td'); if(cls) td.className=cls; td.textContent=txt; return td; }
function cellHTML(html, cls=''){ const td=document.createElement('td'); if(cls) td.className=cls; td.innerHTML=html; return td; }
function badge(txt, cls){ return `<span class="badge ${cls}">${txt}</span>`; }
function yesNo(b){ return b ? 'âœ…' : 'â€“'; }

function showEmptySignals(){
  const tr=document.createElement('tr');
  tr.appendChild(cell('Keine Signale'));
  for(let i=0;i<10;i++) tr.appendChild(cell(''));
  $signalsBody.appendChild(tr);
}

function showError(where, err){
  const tr=document.createElement('tr');
  tr.className='row-error';
  tr.appendChild(cellHTML(`${badge('Fehler','err')} ${where}: ${String(err).slice(0,200)}`));
  for(let i=0;i<10;i++) tr.appendChild(cell(''));
  $signalsBody.appendChild(tr);
}

function sparkline(values){
  if(!Array.isArray(values) || values.length < 2) return '';
  const w=130, h=28, pad=2;
  const min=Math.min(...values), max=Math.max(...values);
  const span=max-min || 1e-9;
  const step=(w-2*pad)/(values.length-1);
  const pts=values.map((v,i)=>{
    const x=pad+i*step;
    const y=h - pad - ((v-min)/span)*(h-2*pad);
    return `${x.toFixed(2)},${y.toFixed(2)}`;
  }).join(' ');
  const last=values[values.length-1], first=values[0];
  const up = last >= first;
  const stroke = up ? '#4ade80' : '#60a5fa';
  return `
    <svg class="spark" viewBox="0 0 ${w} ${h}" preserveAspectRatio="none" aria-hidden="true">
      <polyline points="${pts}" fill="none" stroke="${stroke}" stroke-width="2" />
    </svg>`;
}

function renderSignals(list){
  $signalsBody.innerHTML = '';

  if(!Array.isArray(list) || list.length===0){ showEmptySignals(); return; }

  // Filter nur BUY
  let rows = $onlyBuys.checked ? list.filter(s => s.recommendation === 'BUY') : list.slice();

  // Sortierung
  rows.sort((a,b)=>{
    // BUYs immer nach oben
    const wa = a.recommendation==='BUY' ? 0 : 1;
    const wb = b.recommendation==='BUY' ? 0 : 1;
    if(wa!==wb) return wa-wb;
    const da = Number(a.pct_move||0), db = Number(b.pct_move||0);
    return $sortDesc.checked ? (db-da) : (da-db);
  });

  if(rows.length===0){ showEmptySignals(); return; }

  for(const s of rows){
    const tr=document.createElement('tr');
    tr.appendChild(cell(s.symbol || 'â€“'));
    tr.appendChild(cell(`$ ${fmtNum(s.price,4)}`,'right'));
    tr.appendChild(cell(`${fmtNum(s.pct_move)}%`,'right'));
    tr.appendChild(cell(fmtNum(s.rsi),'right'));
    tr.appendChild(cell(yesNo(!!s.breakout),'center'));
    tr.appendChild(cell(yesNo(!!s.momentum),'center'));
    const rec = (s.recommendation||'HOLD').toUpperCase();
    tr.appendChild(cellHTML(badge(rec, rec==='BUY'?'buy':'hold'), 'center'));

    // SL / TP / Trailing (Prozent bevorzugt, sonst Preis)
    const sl = s.sl_percent!=null ? `${fmtNum(s.sl_percent)}%` : (s.sl_price!=null ? `$ ${fmtNum(s.sl_price,4)}` : 'â€“');
    const tp = s.tp_percent!=null ? `${fmtNum(s.tp_percent)}%` : (s.tp_price!=null ? `$ ${fmtNum(s.tp_price,4)}` : 'â€“');
    const trl = s.trailing_percent!=null ? `${fmtNum(s.trailing_percent)}%` : 'â€“';
    tr.appendChild(cell(sl,'right'));
    tr.appendChild(cell(tp,'right'));
    tr.appendChild(cell(trl,'right'));

    // KI Badge (Score oder â€žKIâ€œ wenn vorhanden)
    let kiCell = 'â€“';
    if (s.ki_score!=null) kiCell = badge(`KI ${fmtNum(s.ki_score,1)}`,'ki');
    else if (s.sl_percent!=null || s.tp_percent!=null || s.trailing_percent!=null) kiCell = badge('KI','ki');
    tr.appendChild(cellHTML(kiCell,'center'));

    // Sparkline
    tr.appendChild(cellHTML(sparkline(s.spark),'center'));

    $signalsBody.appendChild(tr);
  }
}

function renderExits(list){
  $exitsBody.innerHTML = '';
  if(!Array.isArray(list) || list.length===0){
    const tr=document.createElement('tr');
    tr.appendChild(cell('â€“'));
    tr.appendChild(cell('â€“'));
    tr.appendChild(cell('â€“','right'));
    tr.appendChild(cell('â€“'));
    $exitsBody.appendChild(tr);
    return;
  }
  for(const e of list){
    const tr=document.createElement('tr');
    tr.appendChild(cell(e.timestamp || 'â€“'));
    tr.appendChild(cell(e.symbol || 'â€“'));
    tr.appendChild(cell(e.price!=null ? `$ ${fmtNum(e.price,4)}` : 'â€“','right'));
    tr.appendChild(cell(e.reason || 'â€“'));
    $exitsBody.appendChild(tr);
  }
}

async function loadJSON(path){
  const url = `${path}?t=${Date.now()}`; // Cache-Bust
  const res = await fetch(url, {cache:'no-store'});
  if(!res.ok) throw new Error(`${res.status} ${res.statusText}`);
  return await res.json();
}

async function refresh(){
  $signalsBody.innerHTML = '<tr><td colspan="11" class="muted">Lade Daten â€¦</td></tr>';
  try{
    const [sigRes, exRes] = await Promise.allSettled([
      loadJSON('signals.json'),
      loadJSON('exits.json')
    ]);

    if(sigRes.status==='fulfilled'){
      renderSignals(sigRes.value);
      $lastInfo.textContent = `Zuletzt aktualisiert: ${new Date().toLocaleString()}`;
    }else{
      $signalsBody.innerHTML = '';
      showError('signals.json', sigRes.reason);
    }

    if(exRes.status==='fulfilled'){
      renderExits(exRes.value);
    }else{
      renderExits([]); // optional
      console.warn('exits.json:', exRes.reason);
    }
  }catch(err){
    $signalsBody.innerHTML='';
    showError('fetch', err);
  }
}

document.querySelector('#btn-refresh').addEventListener('click', refresh);
$onlyBuys.addEventListener('change', refresh);
$sortDesc.addEventListener('change', refresh);

refresh();
setInterval(refresh, 15000);
</script>
</body>
</html>
